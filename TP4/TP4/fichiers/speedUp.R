#!/usr/bin/env Rscript

## lines of data files must be  "#threads time"

suppressMessages(library(Hmisc)) # contains errbar

args = commandArgs(trailingOnly=TRUE)

nbFichiers = length(args) - 1

if (nbFichiers < 1) {
  stop("At least two argument must be supplied filename [list of filenames] reference-time", call.=FALSE)
}

refTime = as.numeric(args[nbFichiers+1])

tables <- vector(mode = "list", length = nbFichiers)
sdtables <- vector(mode = "list", length = nbFichiers) #sd = standard deviation
xmax = 0
ymax = 0

for(i in 1:nbFichiers)
{
        print(args[i])
        tmp = read.table(args[i])
        tmp[,2] = refTime / tmp[,2]  # compute speed up 
        tables[[i]] = aggregate(tmp[,2], tmp[1], mean)
        truc  = aggregate(tmp[,2], tmp[1], sd)
        truc[is.na(truc)] <- 0  # remplace NA par 0
        sdtables[[i]]=truc
        xmax = max(max(tables[[i]][,1]),xmax)
        ymax = max(max(tables[[i]][,2]+ sdtables[[i]][,2]),ymax)
    }

pdf("speedup.pdf")

plot(1,type='n',xlim=c(0,xmax),ylim=c(0,ymax),xlab='#threads', ylab='speedup')

legend("topleft", legend = args[1:nbFichiers], col=1:nbFichiers, pch=1)

title(main=paste("Speedup (reference time = " ,  args[nbFichiers+1],")"))


for (i in 1:nbFichiers){
    lines(tables[[i]][,1],tables[[i]][,2], type='o', col=i, lwd=2)
    par(fg=i)
    errbar( tables[[i]][,1],tables[[i]][,2],
                tables[[i]][,2]+sdtables[[i]][,2],
             tables[[i]][,2]-sdtables[[i]][,2],
             col=i,add=TRUE)
}

dev.off()
